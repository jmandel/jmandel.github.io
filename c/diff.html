<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DOCX Visual‑Diff — Tables preserved</title>

  <!-- Tailwind (utility classes) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 UMD & Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- JSZip -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
    .diff-add { background:#c6ffd1; color:#065f46; font-weight:600; }
    .diff-del { background:#ffd6d5; color:#8b0000; text-decoration:line-through; }
    table.diff   { border-collapse:collapse; }
    table.diff td{ border:1px solid #d1d5db; padding:2px 6px; }
  </style>
</head>
<body class="bg-gray-50 p-8">
  <div id="root"></div>

  <script type="text/babel">
/*--------------------------------------------------------------------
  0 • buildDocx  – wraps document.xml into a minimal, valid .docx
------------------------------------------------------------------------*/
async function buildDocx(documentXml){
  const zip = new JSZip();

  /* main document part */
  zip.folder('word').file('document.xml', documentXml);
  zip.folder('word/_rels').file('document.xml.rels',
`<?xml version="1.0" encoding="UTF-8"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"/>`);

  /* package relationships */
  zip.folder('_rels').file('.rels',
`<?xml version="1.0" encoding="UTF-8"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1"
    Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument"
    Target="word/document.xml"/>
</Relationships>`);

  /* [Content_Types] */
  zip.file('[Content_Types].xml',
`<?xml version="1.0"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml"  ContentType="application/xml"/>
  <Override PartName="/word/document.xml"
            ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
</Types>`);

  return zip.generateAsync({type:'arraybuffer'});
}

/*--------------------------------------------------------------------
  1 • richer sample documents (old / new)
------------------------------------------------------------------------*/
const SAMPLE_OLD_XML=`<?xml version="1.0"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"><w:body>
  <w:p><w:r><w:t>The quick brown fox jumps over the lazy dog.</w:t></w:r></w:p>

  <w:p><w:r><w:t>- Apples</w:t></w:r></w:p>
  <w:p><w:r><w:t>- Bananas</w:t></w:r></w:p>
  <w:p><w:r><w:t>- Cherries</w:t></w:r></w:p>

  <w:tbl>
    <w:tr>
      <w:tc><w:p><w:r><w:t>Item</w:t></w:r></w:p></w:tc>
      <w:tc><w:p><w:r><w:t>Price</w:t></w:r></w:p></w:tc>
    </w:tr>
    <w:tr>
      <w:tc><w:p><w:r><w:t>Notebook</w:t></w:r></w:p></w:tc>
      <w:tc><w:p><w:r><w:t>1.99</w:t></w:r></w:p></w:tc>
    </w:tr>
  </w:tbl>

  <w:p><w:r><w:t>This paragraph will be removed.</w:t></w:r></w:p>
</w:body></w:document>`;

const SAMPLE_NEW_XML=`<?xml version="1.0"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"><w:body>
  <w:p><w:r><w:t>The quick red fox leaps over the lazy dog.</w:t></w:r></w:p>

  <w:p><w:r><w:t>- Apples</w:t></w:r></w:p>
  <w:p><w:r><w:t>- Blueberries</w:t></w:r></w:p>
  <w:p><w:r><w:t>- Cherries</w:t></w:r></w:p>
  <w:p><w:r><w:t>- Dates</w:t></w:r></w:p>

  <w:tbl>
    <w:tr>
      <w:tc><w:p><w:r><w:t>Item</w:t></w:r></w:p></w:tc>
      <w:tc><w:p><w:r><w:t>Price</w:t></w:r></w:p></w:tc>
      <w:tc><w:p><w:r><w:t>Stock</w:t></w:r></w:p></w:tc>
    </w:tr>
    <w:tr>
      <w:tc><w:p><w:r><w:t>Notebook</w:t></w:r></w:p></w:tc>
      <w:tc><w:p><w:r><w:t>2.49</w:t></w:r></w:p></w:tc>
      <w:tc><w:p><w:r><w:t>17</w:t></w:r></w:p></w:tc>
    </w:tr>
  </w:tbl>

  <w:p><w:r><w:t>This is an entirely new paragraph added at the end.</w:t></w:r></w:p>
</w:body></w:document>`;

/*--------------------------------------------------------------------
  2 • Myers shortest‑edit‑script (token level)
------------------------------------------------------------------------*/
function eqTok(a,b){
  return (a.type==='whitespace' && b.type==='whitespace') || a.text===b.text;
}
function myers(a,b){
  const n=a.length,m=b.length,max=n+m,v={}; v[1]=0; const trace=[];
  for(let d=0;d<=max;d++){
    trace.push({...v});
    for(let k=-d;k<=d;k+=2){
      let x;
      if(k===-d||(k!==d&&v[k-1]<v[k+1])) x=v[k+1];
      else x=v[k-1]+1;
      let y=x-k;
      while(x<n && y<m && eqTok(a[x],b[y])){x++;y++;}
      v[k]=x;
      if(x>=n && y>=m) return backtrack(trace,a,b,x,y,d);
    }
  }
  return [];
}
function backtrack(trace,a,b,x,y,d){
  const diff=[];
  for(let d2=d;d2>=0&&(x>0||y>0);d2--){
    const v=trace[d2],k=x-y;
    const prevK=(k===-d2||(k!==d2&&v[k-1]<v[k+1]))?k+1:k-1;
    const prevX=v[prevK],prevY=prevX-prevK;

    while(x>prevX && y>prevY){
      diff.unshift({value:a[x-1].text,
                    old:a[x-1].runKey,
                    new:b[y-1].runKey});
      x--; y--;
    }
    if(d2>0){
      if(x>prevX){
        diff.unshift({value:a[x-1].text,
                      old:a[x-1].runKey,
                      removed:true});
        x--;
      }else{
        diff.unshift({value:b[y-1].text,
                      new:b[y-1].runKey,
                      added:true});
        y--;
      }
    }
  }
  return diff;
}

/*--------------------------------------------------------------------
  3 • Canonicaliser  (paragraphs + basic tables)
------------------------------------------------------------------------*/
class Canon{
  constructor(){this.p=0;this.t=0;this.meta={};}
  async parseBuffer(buf){
    const zip=await JSZip.loadAsync(buf);
    const xml=await zip.file('word/document.xml').async('string');
    return this.parse(xml);
  }
  parse(xml){
    const doc=new DOMParser().parseFromString(xml,'application/xml');
    const body=doc.querySelector('w\\:body,body');
    const tokens=[]; this.walk(body,tokens); return {tokens,meta:this.meta};
  }
  walk(node,tokens){
    node.childNodes.forEach(n=>{
      if(n.nodeType!==1) return;
      if(/p$/i.test(n.tagName)) this.para(n,tokens);
      else if(/tbl$/i.test(n.tagName)) this.table(n,tokens);
    });
  }
  para(p,tokens){
    const id='p'+this.p++; tokens.push(mark('«p»',id)); let idx=0;
    p.querySelectorAll('w\\:t,t').forEach(t=>{
      (t.textContent.match(/\S+|\s+/g)||[]).forEach(part=>{
        tokens.push({type:/\s/.test(part)?'whitespace':'word',
                     text:/\s/.test(part)?' ':part,
                     runKey:{blockId:id,runIdx:idx++}});
      });
    });
    tokens.push(mark('«/p»',id));
  }
  table(tbl,tokens){
    const tid='tbl'+this.t++; tokens.push(mark('«table»',tid));
    tbl.querySelectorAll('w\\:tr,tr').forEach((tr,ri)=>{
      const rid=`${tid}.tr${ri}`; tokens.push(mark('«tr»',rid));
      tr.querySelectorAll('w\\:tc,tc').forEach((tc,ci)=>{
        const cid=`${rid}.tc${ci}`;
        this.meta[cid]={width:this.tcWidth(tc)};
        tokens.push(mark('«tc»',cid));
        tc.querySelectorAll('w\\:p,p').forEach(p=>this.para(p,tokens));
        tokens.push(mark('«/tc»',cid));
      });
      tokens.push(mark('«/tr»',rid));
    });
    tokens.push(mark('«/table»',tid));
  }
  tcWidth(tc){
    const w=tc.querySelector('w\\:tcw'); return w?parseInt(w.getAttribute('w:w')):null;
  }
}
const mark=(text,bid)=>({type:'marker',text,runKey:{blockId:bid,runIdx:-1}});

/*--------------------------------------------------------------------
  4 • Renderer helpers                                              */
const twipToPx=tw=>Math.round((tw||2400)*0.05);

/* HTML preview */
function diffToHtml(diff,meta){
  const root=document.createElement('div'),stack=[];
  const open=(tag,attrs={})=>{
    const el=document.createElement(tag);
    Object.entries(attrs).forEach(([k,v])=>el.setAttribute(k,v));
    (stack[stack.length-1]||root).appendChild(el);
    stack.push(el);
  };
  const close=()=>stack.pop();

  diff.forEach(p=>{
    if(p.value.startsWith('«')){
      switch(p.value){
        case '«p»': open('p'); break;
        case '«/p»': close(); break;
        case '«table»': open('table',{class:'diff'}); break;
        case '«/table»': close(); break;
        case '«tr»': open('tr'); break;
        case '«/tr»': close(); break;
        case '«tc»':{
          const id=p.new?.blockId||p.old?.blockId;
          open('td',{style:`width:${twipToPx(meta[id]?.width)}px`});
          break;
        }
        case '«/tc»': close(); break;
      }
      return;
    }
    const span=document.createElement('span');
    span.textContent=p.value;
    if(p.added) span.className='diff-add';
    if(p.removed) span.className='diff-del';
    (stack[stack.length-1]||root).appendChild(span);
  });
  return root.innerHTML;
}

/* WordprocessingML generator (paragraphs + tables) */
function diffToDocumentXml(diff,meta){
  const runs=[];

  /* helpers to wrap text in w:r with optional formatting */
  const runAdd = txt => `<w:r><w:rPr><w:color w:val="00B050"/><w:highlight w:val="lightGreen"/></w:rPr><w:t xml:space="preserve">${txt}</w:t></w:r>`;
  const runDel = txt => `<w:r><w:rPr><w:color w:val="FF0000"/><w:strike/></w:rPr><w:t xml:space="preserve">${txt}</w:t></w:r>`;
  const runNorm= txt => `<w:r><w:t xml:space="preserve">${txt}</w:t></w:r>`;

  let xml="<w:body>";
  let state='outside';               // outside | p | tbl | tr | tc
  const open = part => { xml+=part; };
  const close= part => { xml+=part; };

  const openTable=()=>{open('<w:tbl>'); state='tbl';};
  const closeTable=()=>{if(state==='tc'){closeCell();} if(state==='tr'){closeRow();} close('</w:tbl>'); state='outside';};
  const openRow=()=>{open('<w:tr>'); state='tr';};
  const closeRow=()=>{if(state==='tc'){closeCell();} close('</w:tr>'); state='tbl';};
  const openCell=(cid)=>{
    const w=meta[cid]?.width;
    open(`<w:tc>${w?`<w:tcPr><w:tcW w:w="${w}" w:type="dxa"/></w:tcPr>`:''}<w:p>`);
    state='tc';
  };
  const closeCell=()=>{close('</w:p></w:tc>'); state='tr';};

  const openPara=()=>{open('<w:p>'); state='p';};
  const closePara=()=>{close('</w:p>'); state='outside';};

  diff.forEach(p=>{
    if(p.value.startsWith('«')){
      switch(p.value){
        case '«p»': openPara(); break;
        case '«/p»': closePara(); break;
        case '«table»': openTable(); break;
        case '«/table»': closeTable(); break;
        case '«tr»': openRow(); break;
        case '«/tr»': closeRow(); break;
        case '«tc»':{
          const cid=p.new?.blockId||p.old?.blockId;
          openCell(cid);
          break;
        }
        case '«/tc»': closeCell(); break;
      }
      return;
    }
    const runXml = p.added?runAdd(p.value):p.removed?runDel(p.value):runNorm(p.value);
    open(runXml);
  });

  if(state==='p') closePara();
  if(state==='tc') closeCell();
  if(state==='tr') closeRow();
  if(state==='tbl') closeTable();

  xml+="</w:body>";
  return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">${xml}</w:document>`;
}

/*--------------------------------------------------------------------
  5 • React UI                                                    */
function App(){
  const [oldBuf,setOld]     = React.useState(null);
  const [newBuf,setNew]     = React.useState(null);
  const [html,setHtml]      = React.useState('');
  const [docxBuf,setDocxBuf]= React.useState(null);
  const log = msg => console.log(msg);

  /* load sample buffers */
  const loadSamples = async () =>{
    setOld(await buildDocx(SAMPLE_OLD_XML));
    setNew(await buildDocx(SAMPLE_NEW_XML));
    log('samples loaded');
  };

  /* run pipeline */
  const generate = async () =>{
    if(!oldBuf||!newBuf){alert('Provide both docs');return;}

    const oldC=new Canon(), newC=new Canon();
    const [o,n]=await Promise.all([oldC.parseBuffer(oldBuf),newC.parseBuffer(newBuf)]);
    const diff=myers(o.tokens,n.tokens);

    setHtml(diffToHtml(diff,n.meta));
    const xml=diffToDocumentXml(diff,n.meta);
    setDocxBuf(await buildDocx(xml));
  };

  /* download helper */
  const save = () =>{
    const blob=new Blob([docxBuf],{type:'application/vnd.openxmlformats-officedocument.wordprocessingml.document'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download='diff.docx';a.click();
    URL.revokeObjectURL(url);
  };

  return(
    <div className="max-w-6xl mx-auto bg-white p-8 shadow rounded space-y-6">
      <h1 className="text-2xl font-bold">DOCX Visual‑Diff — tables preserved</h1>

      <div className="space-x-4">
        <button className="px-4 py-2 bg-slate-600 text-white rounded" onClick={loadSamples}>Load samples</button>
        <button className="px-4 py-2 bg-blue-600 text-white rounded" onClick={generate}>Generate diff</button>
        <button className="px-4 py-2 bg-green-600 text-white rounded" disabled={!docxBuf} onClick={save}>Download diff.docx</button>
      </div>

      <div className="prose max-w-none border p-4 rounded overflow-x-auto" dangerouslySetInnerHTML={{__html:html}}></div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
