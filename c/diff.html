<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DOCXÂ Visualâ€‘DiffÂ PrototypeÂ (StructuredÂ HTMLÂ Renderer)</title>

  <!-- Tailwind (Play CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ReactÂ &Â ReactDOMÂ (v18Â UMD)Â +Â BabelÂ forÂ inâ€‘browserÂ JSX -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /*  ðŸ”†  Diff highlight utilities  */
    .diff-add   { background:#c6ffd1; color:#065f46; font-weight:600; }
    .diff-del   { background:#ffd6d5; color:#8b0000; text-decoration:line-through; }
    table.diff  { border-collapse:collapse; }
    table.diff td { border:1px solid #d1d5db; padding:2px 6px; }
  </style>
</head>

<body class="bg-gray-50 p-8">
  <div id="root"></div>

  <script type="text/babel">
    /******************************************************************
     * 1.  Sample diffParts  â€“Â normally produced by Myers diff engine *
     ******************************************************************/
    const sampleDiff = [
      { value:'Â«pÂ»' },
      { value:'The',  old:{blockId:'p1',runIdx:0}, new:{blockId:'p1',runIdx:0} },
      { value:' ',    old:{}, new:{} },
      { value:'quick',old:{blockId:'p1',runIdx:1}, new:{blockId:'p1',runIdx:1} },
      { value:' ',    old:{}, new:{} },
      { value:'brown',old:{blockId:'p1',runIdx:2}, removed:true },
      { value:'red',                   new:{blockId:'p1',runIdx:2}, added:true },
      { value:' ', old:{}, new:{} },
      { value:'fox',  old:{blockId:'p1',runIdx:3}, new:{blockId:'p1',runIdx:3} },
      { value:'Â«/pÂ»' },

      { value:'Â«tableÂ»' },
      { value:'Â«trÂ»' },
      { value:'Â«tcÂ»' },
      { value:'Cell', old:{}, new:{} },
      { value:' ',    old:{}, new:{} },
      { value:'1',    old:{}, new:{} },
      { value:'Â«/tcÂ»' },

      { value:'Â«tcÂ»' },
      { value:'Modified', added:true, new:{blockId:'tbl0.tr0.tc1',runIdx:0} },
      { value:' ',       added:true, new:{blockId:'tbl0.tr0.tc1',runIdx:1} },
      { value:'Cell',    old:{blockId:'tbl0.tr0.tc1',runIdx:0}, new:{blockId:'tbl0.tr0.tc1',runIdx:2} },
      { value:'Â«/tcÂ»' },

      { value:'Â«tcÂ»' },
      { value:'Extra', added:true, new:{blockId:'tbl0.tr0.tc2',runIdx:0} },
      { value:'Â«/tcÂ»' },
      { value:'Â«/trÂ»' },
      { value:'Â«/tableÂ»' }
    ];

    /******************************************************************
     * 2.  Minimal stubÂ metaMapÂ â€“Â just widths for table columns        *
     ******************************************************************/
    const metaMap = {
      'tbl0.tr0.tc0': { width: 2500 },
      'tbl0.tr0.tc1': { width: 2500 },
      'tbl0.tr0.tc2': { width: 2500 },
    };

    const twipToPx = twip => Math.round((twip || 2400) * 0.05); // 1 twip â‰ˆÂ 0.05â€¯px

    /******************************************************************
     * 3.  Structured rendererÂ â†’ HTML string                           *
     ******************************************************************/
    function diffPartsToHtml(diff, meta) {
      const root = document.createElement('div');
      const stack = [];

      const open = (tag, attrs = {}) => {
        const el = document.createElement(tag);
        Object.entries(attrs).forEach(([k, v]) => (el[k] = v));
        (stack[stack.length - 1] || root).appendChild(el);
        stack.push(el);
      };
      const close = () => stack.pop();

      for (const part of diff) {
        const { value, added, removed } = part;

        // --- markers -------------------------------------------------
        if (value.startsWith('Â«') && value.endsWith('Â»')) {
          switch (true) {
            case value === 'Â«pÂ»':     open('p');                break;
            case value === 'Â«/pÂ»':    close();                 break;

            case value === 'Â«tableÂ»': open('table', { className:'diff' }); break;
            case value === 'Â«/tableÂ»':close();                 break;

            case value === 'Â«trÂ»':    open('tr');               break;
            case value === 'Â«/trÂ»':   close();                 break;

            case value === 'Â«tcÂ»': {
              const blockId = part.new?.blockId || part.old?.blockId;
              const width   = twipToPx(meta[blockId]?.width);
              open('td', { style:`width:${width}px` });
              break;
            }
            case value === 'Â«/tcÂ»':   close();                 break;

            // list markers etc. could be handled here
          }
          continue;
        }

        // --- word / whitespace ---------------------------------------
        const span = document.createElement('span');
        span.textContent = value;
        if (added)   span.className = 'diff-add';
        if (removed) span.className = 'diff-del';
        (stack[stack.length - 1] || root).appendChild(span);
      }
      return root.innerHTML;
    }

    /******************************************************************
     * 4.  React demo component                                        *
     ******************************************************************/
    function App() {
      const html = diffPartsToHtml(sampleDiff, metaMap);

      return (
        <div className="max-w-3xl mx-auto bg-white shadow rounded p-8">
          <h1 className="text-2xl font-bold mb-4">Structured HTML preview</h1>
          <div
            className="border border-gray-300 p-4 prose max-w-none"
            dangerouslySetInnerHTML={{ __html: html }}
          />
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
