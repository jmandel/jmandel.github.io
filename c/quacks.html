<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quacks of Quedlinburg</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            margin: 0 auto;
            min-height: 100vh;
        }
        
        .game-container {
            display: grid;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Mobile/tablet layout */
        @media (max-width: 1199px) {
            .game-container {
                grid-template-columns: 1fr;
                max-width: 900px;
            }
        }
        
        /* Desktop layout */
        @media (min-width: 1200px) {
            .game-container {
                grid-template-columns: 300px 350px 1fr;
                grid-template-areas: 
                    "rules sidebar main"
                    "rules sidebar main";
                gap: 20px;
            }
            
            .sidebar {
                grid-area: sidebar;
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            
            .main-area {
                grid-area: main;
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            
            .rules-panel {
                grid-area: rules;
                display: flex;
                flex-direction: column;
                gap: 15px;
                position: sticky;
                top: 10px;
                height: fit-content;
                max-height: calc(100vh - 20px);
                overflow-y: auto;
            }
        }
        
        .section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        /* Mobile/tablet sections keep margin */
        @media (max-width: 1199px) {
            .section {
                margin-bottom: 20px;
            }
        }
        
        h2 {
            font-size: 20px;
            margin-bottom: 16px;
            color: #2c3e50;
            font-weight: 600;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
        }
        
        .bag-contents {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .chip-count {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            font-size: 14px;
            border: 1px solid #dee2e6;
            font-weight: 500;
        }
        
        .chip {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            cursor: pointer;
            user-select: none;
        }
        
        .chip.white { 
            background: #f0f0f0; 
            color: #333; 
            text-shadow: none; 
            border: 2px solid #999;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(0,0,0,.1) 2px, rgba(0,0,0,.1) 4px);
        }
        .chip.orange { 
            background: #ff8c00; 
            background-image: repeating-linear-gradient(90deg, transparent, transparent 3px, rgba(255,255,255,.3) 3px, rgba(255,255,255,.3) 6px);
        }
        .chip.green { 
            background: #4a7c59; 
            background-image: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,.2) 2px, rgba(255,255,255,.2) 4px);
        }
        .chip.blue { 
            background: #2e5d8a; 
            background-image: repeating-linear-gradient(135deg, transparent, transparent 3px, rgba(255,255,255,.2) 3px, rgba(255,255,255,.2) 6px);
        }
        .chip.red { 
            background: #b71c1c; 
            background-image: radial-gradient(circle at 30% 30%, rgba(255,255,255,.3), transparent 50%);
        }
        .chip.yellow { 
            background: #ffeb3b; 
            color: #333; 
            text-shadow: none; 
            background-image: repeating-linear-gradient(45deg, rgba(0,0,0,.1), rgba(0,0,0,.1) 2px, transparent 2px, transparent 4px);
        }
        .chip.purple { 
            background: #6a1b9a; 
            background-image: repeating-linear-gradient(45deg, transparent, transparent 4px, rgba(255,255,255,.2) 4px, rgba(255,255,255,.2) 8px);
        }
        .chip.black { 
            background: #212121; 
            background-image: repeating-linear-gradient(90deg, transparent, transparent 1px, rgba(255,255,255,.1) 1px, rgba(255,255,255,.1) 2px);
        }
        
        .tray {
            min-height: 60px;
            background: #f9f9f9;
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }
        
        .tray .chip {
            cursor: move;
        }
        
        .flask {
            width: 32px;
            height: 32px;
            font-size: 24px;
            cursor: pointer;
            user-select: none;
            margin-left: 10px;
            opacity: 0.3;
            transition: opacity 0.2s ease;
        }
        
        .flask.active {
            opacity: 1;
        }
        
        .board {
            display: grid;
            grid-template-columns: repeat(11, 1fr);
            gap: 3px;
            margin-top: 10px;
            position: relative;
        }
        
        .space {
            width: 60px;
            height: 60px;
            border: 2px solid #ddd;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            position: relative;
            background: #fafafa;
            padding: 2px;
            cursor: pointer;
            min-width: 60px;
            min-height: 60px;
            flex-shrink: 0;
        }
        
        .space.filled {
            background: #e8f5e9;
        }
        
        .space.has-ruby {
            border-color: #e91e63;
            background: #fce4ec;
        }
        
        .space.has-droplet {
            border-color: #2196f3;
            border-width: 3px;
        }
        
        .space-info {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 1;
        }
        
        .space-vp {
            color: #2196f3;
            font-weight: bold;
            font-size: 16px;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
        }
        
        .space-coins {
            color: #ff9800;
            font-weight: bold;
            font-size: 16px;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
        }
        
        .space-ruby {
            color: #e91e63;
            font-size: 20px;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
        }
        
        .space-number {
            position: absolute;
            bottom: 1px;
            right: 2px;
            font-size: 7px;
            color: #999;
            z-index: 1;
        }
        
        .space .chip {
            position: relative;
            z-index: 2;
            margin: 0;
        }
        
        button {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        
        button:hover {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }
        
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }
        
        .btn-info:hover {
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .stat {
            text-align: center;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .action-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .manual-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .manual-controls > span {
            min-width: 60px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .manual-controls .control-inputs {
            display: flex;
            gap: 8px;
            align-items: center;
            flex: 1;
        }
        
        .icon-button {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .icon-button::before {
            font-size: 16px;
        }
        
        /* Icon definitions */
        .icon-vp-plus::before { content: "🏆"; }
        .icon-vp-minus::before { content: "🏆"; }
        .icon-ruby-plus::before { content: "💎"; }
        .icon-ruby-minus::before { content: "💎"; }
        .icon-droplet-right::before { content: "💧"; }
        .icon-droplet-left::before { content: "💧"; }
        .icon-clear::before { content: "🗑️"; }
        .icon-reset::before { content: "🔄"; }
        .icon-add::before { content: "➕"; }
        .icon-remove::before { content: "➖"; }
        .icon-draw::before { content: "🎒"; }
        .icon-end-turn::before { content: "✅"; }
        
        .warning {
            color: #d32f2f;
            font-weight: bold;
            margin-left: 10px;
        }
        
        select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .scoring-track {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 2px;
            margin-top: 10px;
        }
        
        .score-space {
            border: 1px solid #ddd;
            padding: 5px;
            text-align: center;
            font-size: 12px;
            border-radius: 4px;
            position: relative;
        }
        
        .score-space.current {
            background: #4CAF50;
            color: white;
            font-weight: bold;
        }
        
        .score-space.has-rat-tail::after {
            content: '🐀';
            position: absolute;
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
        }
        
        .player-info {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        input[type="text"] {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .books-config {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .book-selector {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .chip-price {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px;
            background: #f0f0f0;
            border-radius: 4px;
            font-size: 12px;
            margin: 2px 0;
        }
        
        .rule-text {
            font-size: 12px;
            color: #666;
            font-style: italic;
            margin-top: 5px;
            padding: 5px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        
        .droplet-indicator {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 16px;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Book definitions
        const books = {
            yellow: {
                1: {
                    prices: { 1: 8, 2: 12, 4: 18 },
                    rule: "If the previously played chip was white, put the white chip back into the bag."
                },
                2: {
                    prices: { 1: 8, 2: 12, 4: 18 },
                    rule: "Explosion threshold increases: 1 yellow chip → need >8, 3+ yellow chips → need >9"
                }
            },
            green: {
                1: {
                    prices: { 1: 4, 2: 8, 4: 14 },
                    rule: "For each green chip on the last or next-to-last space, receive 1 ruby."
                },
                2: {
                    prices: { 1: 6, 2: 11, 4: 21 },
                    rule: "If white chips = exactly 7, double the value of each green chip for the rest of the turn."
                }
            },
            red: {
                1: {
                    prices: { 1: 6, 2: 10, 4: 16 },
                    rule: "Move red chip forward by 1 if 1-2 orange chips in pot, by 2 if 3+ orange chips."
                },
                2: {
                    prices: { 1: 5, 2: 9, 4: 15 },
                    rule: "If previous chip was white, add its value to red chip and move that many spaces."
                }
            },
            blue: {
                1: {
                    prices: { 1: 5, 2: 10, 4: 19 },
                    rule: "Draw 1, 2, or 4 chips from bag (based on chip value). You may place one of them."
                },
                2: {
                    prices: { 1: 4, 2: 8, 4: 14 },
                    rule: "If this chip is on a ruby space, immediately receive 1 ruby."
                }
            },
            purple: {
                1: {
                    prices: { 1: 9 },
                    rule: "1 purple = 1 VP, 2 purple = 1 VP + 1 ruby, 3+ purple = 2 VP + move droplet forward"
                },
                2: {
                    prices: { 1: 10 },
                    rule: "VP based on space: ≤9 = 0 VP, ≥10 = 1 VP, ≥20 = 2 VP, ≥30 = 3 VP"
                }
            },
            black: {
                1: {
                    prices: { 1: 10 },
                    rule: "If you draw more black than a neighbor, move droplet forward. More than both = +1 ruby too."
                }
            },
            orange: {
                1: {
                    prices: { 1: 3 },
                    rule: "No special rules."
                }
            }
        };

        // Default game state
        const defaultGameState = {
            playerName: '',
            selectedBooks: {
                yellow: 1,
                green: 1,
                red: 1,
                blue: 1,
                purple: 1,
                black: 1,
                orange: 1
            },
            bag: {
                white: [1,1,1,1,2,2,3],
                orange: [1],
                green: [1],
                blue: [],
                red: [],
                yellow: [],
                purple: [],
                black: []
            },
            tray: [],
            board: new Array(33).fill(null),
            score: 0,
            rubies: 0,
            droplet: 0,
            spentMoney: 0,
            round: 1,
            flaskActive: true,
            bookSelectionOpen: true
        };

        // Load game state from localStorage or use default
        function loadGameState() {
            try {
                const saved = localStorage.getItem('quacksGameState');
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (e) {
                console.warn('Failed to load game state from localStorage:', e);
            }
            return { ...defaultGameState };
        }

        // Save game state to localStorage
        function saveGameState() {
            try {
                localStorage.setItem('quacksGameState', JSON.stringify(gameState));
            } catch (e) {
                console.warn('Failed to save game state to localStorage:', e);
            }
        }

        // Initialize game state
        let gameState = loadGameState();

        // Board space data
        const spaceData = {
            currency: [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32],
            vp: [0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,6,6,6,7,7,7,8,8],
            rubies: [6,10,14,17,21,25,29,31] // Space indices (1-based) that have rubies
        };

        // Rat tail positions on scoring track
        const ratTailPositions = [1,4,7,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48];

        // Draw a random chip from bag to tray
        function drawChip() {
            const availableColors = Object.keys(gameState.bag).filter(color => 
                gameState.bag[color].length > 0
            );
            
            if (availableColors.length === 0) return;
            
            const totalChips = availableColors.reduce((sum, color) => 
                sum + gameState.bag[color].length, 0
            );
            
            let random = Math.floor(Math.random() * totalChips);
            
            for (const color of availableColors) {
                if (random < gameState.bag[color].length) {
                    const value = gameState.bag[color].splice(random, 1)[0];
                    gameState.tray.push({ color, value });
                    saveGameState();
                    render();
                    return;
                }
                random -= gameState.bag[color].length;
            }
        }

        // Return chip from tray to bag
        function returnChipToBag(index) {
            const chip = gameState.tray.splice(index, 1)[0];
            gameState.bag[chip.color].push(chip.value);
            saveGameState();
            render();
        }

        // Place chip from tray to board
        function placeChipOnBoard(trayIndex, boardSpace) {
            if (gameState.board[boardSpace]) return;
            const chip = gameState.tray.splice(trayIndex, 1)[0];
            gameState.board[boardSpace] = chip;
            saveGameState();
            render();
        }

        // Return chip from board to tray
        function returnChipToTray(boardSpace) {
            const chip = gameState.board[boardSpace];
            if (!chip) return;
            gameState.board[boardSpace] = null;
            gameState.tray.push(chip);
            saveGameState();
            render();
        }

        // Calculate white chip total on board
        function getWhiteTotal() {
            return gameState.board.reduce((sum, chip) => {
                if (chip && chip.color === 'white') {
                    return sum + chip.value;
                }
                return sum;
            }, 0);
        }

        // Get the last filled space
        function getLastFilledSpace() {
            for (let i = gameState.board.length - 1; i >= 0; i--) {
                if (gameState.board[i]) return i;
            }
            return -1;
        }

        // Get the next available space for scoring
        function getNextAvailableSpace() {
            const lastFilledSpace = getLastFilledSpace();
            return lastFilledSpace + 1;
        }

        // Add chip to bag (for shopping)
        function addChipToBag(color, value, price) {
            if (price) {
                // Calculate remaining budget after spent money
                const nextSpace = getNextAvailableSpace();
                const totalMoney = nextSpace < spaceData.currency.length ? spaceData.currency[nextSpace] : 0;
                const remainingMoney = totalMoney - gameState.spentMoney;
                
                if (remainingMoney >= price) {
                    gameState.bag[color].push(value);
                    gameState.spentMoney += price;
                    saveGameState();
                    render();
                } else {
                    alert('Not enough money!');
                }
            } else {
                gameState.bag[color].push(value);
                saveGameState();
                render();
            }
        }

        // Manually remove chip from bag permanently
        function removeChipFromBag(color, value) {
            const chips = gameState.bag[color];
            const index = chips.indexOf(value);
            if (index > -1) {
                chips.splice(index, 1);
                saveGameState();
                render();
            }
        }

        // Toggle flask active/inactive
        function toggleFlask() {
            gameState.flaskActive = !gameState.flaskActive;
            saveGameState();
            render();
        }

        // Toggle book selection panel
        function toggleBookSelection() {
            gameState.bookSelectionOpen = !gameState.bookSelectionOpen;
            saveGameState();
            render();
        }

        // Handle board click
        function handleBoardClick(space) {
            if (gameState.board[space]) {
                returnChipToTray(space);
            } else if (gameState.tray.length > 0) {
                placeChipOnBoard(0, space);
            } else {
                // If tray is empty, draw a chip from bag and place it directly on board
                const availableColors = Object.keys(gameState.bag).filter(color => 
                    gameState.bag[color].length > 0
                );
                
                if (availableColors.length === 0) return;
                
                const totalChips = availableColors.reduce((sum, color) => 
                    sum + gameState.bag[color].length, 0
                );
                
                let random = Math.floor(Math.random() * totalChips);
                
                for (const color of availableColors) {
                    if (random < gameState.bag[color].length) {
                        const value = gameState.bag[color].splice(random, 1)[0];
                        gameState.board[space] = { color, value };
                        saveGameState();
                        render();
                        return;
                    }
                    random -= gameState.bag[color].length;
                }
            }
        }

        // Clear board
        function clearBoard() {
            gameState.board.forEach((chip, i) => {
                if (chip) {
                    gameState.bag[chip.color].push(chip.value);
                    gameState.board[i] = null;
                }
            });
            gameState.tray.forEach(chip => {
                gameState.bag[chip.color].push(chip.value);
            });
            gameState.tray = [];
            saveGameState();
            render();
        }

        // Reset game
        function resetGame() {
            if (!confirm('Are you sure you want to reset the game?')) return;
            gameState = {
                playerName: gameState.playerName,
                selectedBooks: gameState.selectedBooks,
                bag: {
                    white: [1,1,1,1,2,2,3],
                    orange: [1],
                    green: [1],
                    blue: [],
                    red: [],
                    yellow: [],
                    purple: [],
                    black: []
                },
                tray: [],
                board: new Array(33).fill(null),
                score: 0,
                rubies: 0,
                droplet: 0,
                spentMoney: 0,
                round: 1,
                flaskActive: true,
                bookSelectionOpen: gameState.bookSelectionOpen
            };
            saveGameState();
            render();
        }

        // Update player name
        function updatePlayerName(name) {
            gameState.playerName = name;
            saveGameState();
        }

        // Update selected book
        function updateBook(color, bookNumber) {
            gameState.selectedBooks[color] = parseInt(bookNumber);
            saveGameState();
            render();
        }

        // Get available chips for purchase based on money and round restrictions
        function getAvailableChips(money) {
            const available = [];
            Object.keys(books).forEach(color => {
                // Round restrictions
                if (color === 'yellow' && gameState.round < 2) return;
                if (color === 'purple' && gameState.round < 3) return;
                
                const book = books[color][gameState.selectedBooks[color]];
                if (book && book.prices) {
                    Object.entries(book.prices).forEach(([value, price]) => {
                        if (price <= money) {
                            available.push({ color, value: parseInt(value), price });
                        }
                    });
                }
            });
            return available.sort((a, b) => a.price - b.price);
        }

        // Get detailed bag contents (color+value combinations)
        function getBagContentsDetailed() {
            const detailed = [];
            Object.entries(gameState.bag).forEach(([color, chips]) => {
                const valueCounts = {};
                chips.forEach(value => {
                    valueCounts[value] = (valueCounts[value] || 0) + 1;
                });
                Object.entries(valueCounts).forEach(([value, count]) => {
                    if (count > 0) {
                        detailed.push({ color, value: parseInt(value), count });
                    }
                });
            });
            return detailed.sort((a, b) => a.color.localeCompare(b.color) || a.value - b.value);
        }

        // Take VP based on current position
        function takeVP() {
            const lastFilledSpace = getLastFilledSpace();
            if (lastFilledSpace >= 0) {
                const vpGained = spaceData.vp[lastFilledSpace];
                gameState.score += vpGained;
                
                // Award rubies if on ruby spaces
                if (spaceData.rubies.includes(lastFilledSpace + 1)) {
                    gameState.rubies++;
                }
                
                // Reset spent money for next turn
                gameState.spentMoney = 0;
                
                saveGameState();
                render();
            }
        }
        
        // Return all chips to bag
        function returnChipsToBag() {
            clearBoard();
            gameState.round++;
            
            // At start of round 6, automatically add a white 1 to the bag
            if (gameState.round === 6) {
                gameState.bag.white.push(1);
            }
            
            saveGameState();
            render();
        }

        // Render the game
        function render() {
            const app = document.getElementById('app');
            const whiteTotal = getWhiteTotal();
            const nextSpace = getNextAvailableSpace();
            const nextSpaceValue = nextSpace < spaceData.currency.length ? spaceData.currency[nextSpace] : 0;
            const remainingMoney = nextSpaceValue - gameState.spentMoney;
            const nextVP = nextSpace < spaceData.vp.length ? spaceData.vp[nextSpace] : 0;
            const availableChips = getAvailableChips(remainingMoney);
            
            app.innerHTML = `
                <div class="game-container">
                    <!-- Left Panel: Book selection and rules -->
                    <div class="rules-panel">
                        <div class="section">
                            <div onclick="toggleBookSelection()" style="cursor: pointer; font-size: 18px; font-weight: bold; color: #333; margin-bottom: 10px; padding: 5px; border-radius: 4px; background: #f8f9fa;">
                                Book Selection ${gameState.bookSelectionOpen ? '▼' : '▶'}
                            </div>
                            ${gameState.bookSelectionOpen ? `
                                <div class="books-config">
                                    ${Object.keys(books).map(color => `
                                        <div class="book-selector">
                                            <span class="chip ${color}"></span>
                                            <select onchange="updateBook('${color}', this.value)">
                                                ${Object.keys(books[color]).map(num => `
                                                    <option value="${num}" ${gameState.selectedBooks[color] == num ? 'selected' : ''}>
                                                        Book ${num}
                                                    </option>
                                                `).join('')}
                                            </select>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>

                        <div class="section">
                            <h2>Active Book Rules</h2>
                            ${Object.keys(books).map(color => {
                                const book = books[color][gameState.selectedBooks[color]];
                                return book ? `
                                    <div style="margin-bottom: 15px;">
                                        <div style="display: flex; align-items: center; gap: 5px;">
                                            <span class="chip ${color}"></span>
                                            <strong>${color.charAt(0).toUpperCase() + color.slice(1)} Book ${gameState.selectedBooks[color]}:</strong>
                                        </div>
                                        <div class="rule-text">${book.rule}</div>
                                        ${book.prices ? `
                                            <div style="display: flex; gap: 8px; margin-top: 8px; font-size: 11px;">
                                                ${Object.entries(book.prices).map(([value, price]) => `
                                                    <span style="background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 4px; font-weight: 500;">
                                                        ${value}: $${price}
                                                    </span>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : '';
                            }).join('')}
                        </div>
                    </div>

                    <!-- Middle: Bag contents, tray, and quick actions -->
                    <div class="sidebar">
                        <div class="section">
                            <h2>Bag Contents <span style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: normal; margin-left: 10px;">Round ${gameState.round}</span></h2>
                            <div class="bag-contents">
                                ${getBagContentsDetailed().map(({ color, value, count }) => `
                                    <div class="chip-count">
                                        <span class="chip ${color}">${value}</span>
                                        <span>×${count}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="section">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                                <h2 style="margin: 0; border: none; padding: 0;">Tray</h2>
                                <button onclick="drawChip()" class="icon-button icon-draw" style="padding: 6px 12px; font-size: 12px;">Draw</button>
                            </div>
                            <div class="tray">
                                ${gameState.tray.length === 0 ? '<span style="color: #999;">Empty - Draw chips from bag</span>' : ''}
                                ${gameState.tray.map((chip, i) => `
                                    <span class="chip ${chip.color}" 
                                          onclick="returnChipToBag(${i})"
                                          title="Click to return to bag">${chip.value}</span>
                                `).join('')}
                                <div class="flask ${gameState.flaskActive ? 'active' : ''}" 
                                     onclick="toggleFlask()" 
                                     title="Click to toggle flask">🧪</div>
                            </div>
                            ${gameState.tray.length > 0 ? '<p style="margin-top: 5px; font-size: 12px; color: #666;">Click chip to return to bag, or place on board below</p>' : ''}
                        </div>

                        <div class="section">
                            <h2>Quick Actions</h2>
                            <div class="action-row">
                                <button onclick="takeVP()" class="btn-info icon-button icon-end-turn" style="grid-column: 1 / -1;">Take VP</button>
                            </div>
                            <div class="action-row">
                                <button onclick="returnChipsToBag()" class="icon-button icon-clear" style="grid-column: 1 / -1;">Return all chips to bag</button>
                            </div>
                            <div class="action-grid">
                                <button onclick="gameState.score = Math.max(0, gameState.score - 1); saveGameState(); render()" class="icon-button icon-vp-minus">-1 VP</button>
                                <button onclick="gameState.score++; saveGameState(); render()" class="icon-button icon-vp-plus">+1 VP</button>
                                <button onclick="gameState.rubies = Math.max(0, gameState.rubies - 1); saveGameState(); render()" class="icon-button icon-ruby-minus">-1 Ruby</button>
                                <button onclick="gameState.rubies++; saveGameState(); render()" class="icon-button icon-ruby-plus">+1 Ruby</button>
                            </div>
                            
                            <div class="action-row">
                                <button onclick="gameState.droplet = Math.max(0, gameState.droplet - 1); saveGameState(); render()" class="icon-button icon-droplet-left">← Move Droplet</button>
                                <button onclick="gameState.droplet = Math.min(32, gameState.droplet + 1); saveGameState(); render()" class="icon-button icon-droplet-right">Move Droplet →</button>
                            </div>
                            
                            <div style="border-top: 1px solid #ecf0f1; padding-top: 15px; margin-top: 15px;">
                                <div class="manual-controls">
                                    <select id="addColor">
                                        <option value="white">White</option>
                                        <option value="orange">Orange</option>
                                        <option value="green">Green</option>
                                        <option value="blue">Blue</option>
                                        <option value="red">Red</option>
                                        <option value="yellow">Yellow</option>
                                        <option value="purple">Purple</option>
                                        <option value="black">Black</option>
                                    </select>
                                    <select id="addValue">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="4">4</option>
                                    </select>
                                    <button onclick="addChipToBag(document.getElementById('addColor').value, parseInt(document.getElementById('addValue').value))" class="icon-button icon-add" style="flex-grow: 1;">Add</button>
                                </div>
                                
                                <div class="manual-controls">
                                    <select id="removeColor">
                                        <option value="white">White</option>
                                        <option value="orange">Orange</option>
                                        <option value="green">Green</option>
                                        <option value="blue">Blue</option>
                                        <option value="red">Red</option>
                                        <option value="yellow">Yellow</option>
                                        <option value="purple">Purple</option>
                                        <option value="black">Black</option>
                                    </select>
                                    <select id="removeValue">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="4">4</option>
                                    </select>
                                    <button onclick="removeChipFromBag(document.getElementById('removeColor').value, parseInt(document.getElementById('removeValue').value))" class="btn-danger icon-button icon-remove" style="flex-grow: 1;">Remove</button>
                                </div>
                            </div>
                            
                            <div class="action-row" style="margin-top: 20px;">
                                <button onclick="resetGame()" class="icon-button icon-reset btn-danger" style="grid-column: 1 / -1;">Reset Game</button>
                            </div>
                        </div>
                    </div>

                    <!-- Right area: Board, shopping, and scoring -->
                    <div class="main-area">
                        <div class="section">
                            <h2>Board ${whiteTotal > 7 ? '<span class="warning">EXPLOSION!</span>' : ''}</h2>
                            <div class="board">
                                ${gameState.board.map((chip, i) => `
                                    <div class="space ${chip ? 'filled' : ''} ${spaceData.rubies.includes(i + 1) ? 'has-ruby' : ''} ${i === gameState.droplet ? 'has-droplet' : ''}" 
                                         onclick="handleBoardClick(${i})">
                                        ${i === gameState.droplet ? '<div class="droplet-indicator">💧</div>' : ''}
                                        <div class="space-info">
                                            <div class="space-vp">VP: ${spaceData.vp[i]}</div>
                                            <div class="space-coins">$${spaceData.currency[i]}</div>
                                            ${spaceData.rubies.includes(i + 1) ? '<div class="space-ruby">◆</div>' : ''}
                                        </div>
                                        ${chip ? `<span class="chip ${chip.color}">${chip.value}</span>` : ''}
                                        <span class="space-number">${i + 1}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="stats">
                                <div class="stat">
                                    <div class="stat-value">${whiteTotal}</div>
                                    <div class="stat-label">White Total</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value">${nextSpaceValue}</div>
                                    <div class="stat-label">Next Space $</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value">${nextVP}</div>
                                    <div class="stat-label">Next Space VP</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value">${gameState.droplet + 1}</div>
                                    <div class="stat-label">Droplet Position</div>
                                </div>
                            </div>
                        </div>

                        <div class="section">
                            <h2>Available Chips ($${remainingMoney} remaining)</h2>
                            ${availableChips.length === 0 ? '<p style="color: #999;">No chips available with current budget</p>' : ''}
                            ${availableChips.map(({ color, value, price }) => `
                                <div class="chip-price">
                                    <span class="chip ${color}">${value}</span>
                                    <span>$${price}</span>
                                    <button onclick="addChipToBag('${color}', ${value}, ${price})">Add to Bag</button>
                                </div>
                            `).join('')}
                        </div>

                        <div class="section">
                            <h2>Scoring Track</h2>
                            <div class="scoring-track">
                                ${Array.from({length: 50}, (_, i) => `
                                    <div class="score-space ${i === gameState.score ? 'current' : ''} ${ratTailPositions.includes(i) ? 'has-rat-tail' : ''}">
                                        ${i}
                                    </div>
                                `).join('')}
                            </div>
                            <div style="display: flex; justify-content: center; gap: 30px; margin-top: 15px; font-size: 18px; font-weight: bold;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 24px;">🏆</span>
                                    <span style="color: #2c3e50;">${gameState.score}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 24px;">💎</span>
                                    <span style="color: #2c3e50;">${gameState.rubies}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Save state after rendering
            saveGameState();
        }

        // Initial render
        render();
    </script>
</body>
</html>
